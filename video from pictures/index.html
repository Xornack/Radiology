<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video from Pictures - Test Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .folder-selection {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
            transition: border-color 0.3s;
        }
        .folder-selection:hover {
            border-color: #007bff;
        }
        .folder-selection.dragover {
            border-color: #28a745;
            background-color: #f8f9fa;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .file-input {
            display: none;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background-color: #cce7ff;
            border: 1px solid #b3d7ff;
            color: #004085;
        }
        .file-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        .file-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .sorting-info {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            display: none;
        }
        .sort-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 2px;
        }
        .sort-btn:hover {
            background-color: #0056b3;
        }
        .sort-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        /* Phase 2: Video Creation Styles */
        .video-summary {
            margin-top: 15px;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        
        .video-summary h4 {
            margin-top: 0;
            color: #155724;
        }
        
        .video-progress {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .test-video-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .test-video-btn:hover {
            background-color: #138496;
        }
        
        /* Enhanced Progress Tracking Styles (Step 2.3) */
        .enhanced-progress-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: none;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-title {
            font-weight: bold;
            color: #495057;
        }
        
        .eta-display {
            font-size: 14px;
            color: #6c757d;
            background-color: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .step-progress {
            margin-bottom: 15px;
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .step-number.completed {
            background-color: #28a745;
            color: white;
        }
        
        .step-number.active {
            background-color: #007bff;
            color: white;
        }
        
        .step-number.pending {
            background-color: #e9ecef;
            color: #6c757d;
        }
        
        .step-name {
            flex-grow: 1;
            margin-right: 10px;
        }
        
        .step-status {
            font-size: 12px;
            color: #6c757d;
        }
        
        .current-item {
            font-size: 14px;
            color: #495057;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 18px;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .confidence-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .confidence-high {
            background-color: #d4edda;
            color: #155724;
        }
        
        .confidence-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .confidence-low {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Video from Pictures</h1>
            <p>Convert JPEG medical image sequences to MP4 videos</p>
        </div>

        <!-- Folder Selection Area -->
        <div class="folder-selection" id="folderSelection">
            <h3>Select Image Folder</h3>
            <p>Click to browse or drag and drop a folder containing JPEG images</p>
            <button class="btn" onclick="selectFolder()">Browse Folder</button>
            <input type="file" id="folderInput" class="file-input" webkitdirectory multiple accept="image/jpeg,image/jpg">
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status"></div>

        <!-- File List -->
        <div id="fileList" class="file-list"></div>

        <!-- Sorting Info -->
        <div id="sortingInfo" class="sorting-info"></div>

        <!-- Action Buttons -->
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" id="processBtn" disabled onclick="processImages()">Create Video</button>
            <button class="btn" id="settingsBtn" onclick="showSettings()">Settings</button>
        </div>
    </div>

    <!-- Load File System Access Module -->
    <script src="fileSystemAccess.js"></script>
    <script>
        // Global variables for testing
        let selectedFiles = [];
        let folderName = '';

        // Folder selection functionality - Updated for Step 1.2
        async function selectFolder() {
            try {
                showStatus('info', 'Selecting folder...');
                
                // Use the file system access module
                const result = await window.fileSystemModule.selectFiles();
                
                if (result.requiresUserAction) {
                    showStatus('info', result.message);
                    return;
                }
                
                if (result.success) {
                    handleFolderSelectionResult(result);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Folder selection error:', error);
                showStatus('error', `Failed to select folder: ${error.message}`);
                
                // Fall back to file input if needed
                if (window.fileSystemModule.apiSupport.fileInput) {
                    showStatus('info', 'Falling back to file input method...');
                    document.getElementById('folderInput').click();
                }
            }
        }
        
        // Handle successful folder selection result - Updated for Step 1.4
        function handleFolderSelectionResult(result) {
            // Analyze and sort files using natural/numerical ordering
            const sortingAnalysis = window.fileSystemModule.analyzeSortingPattern(result.files);
            console.log('Sorting analysis:', sortingAnalysis);
            
            // Sort files using the recommended method
            selectedFiles = window.fileSystemModule.sortFiles(result.files, sortingAnalysis.recommended);
            folderName = result.folderName;
            
            showStatus('success', 
                `Found ${result.files.length} JPEG files in folder: ${result.folderName} (via ${result.method}). ` +
                `Sorted using ${sortingAnalysis.recommended} method (${Math.round(sortingAnalysis.confidence * 100)}% confidence).`
            );
            displayFileList(selectedFiles);
            displaySortingInfo(sortingAnalysis);
            document.getElementById('processBtn').disabled = false;
            
            // Log browser info for debugging
            console.log('Browser capabilities:', window.fileSystemModule.getBrowserInfo());
        }

        // Handle folder input change - Updated for Step 1.2 and 1.4
        document.getElementById('folderInput').addEventListener('change', function(event) {
            try {
                showStatus('info', 'Processing selected files...');
                
                const files = Array.from(event.target.files).filter(file => 
                    window.fileSystemModule.isValidJPEGFile(file)
                );
                
                if (files.length === 0) {
                    throw new Error('No JPEG files found in selected folder');
                }
                
                const folderName = files[0].webkitRelativePath 
                    ? files[0].webkitRelativePath.split('/')[0] 
                    : 'selected_folder';
                
                const result = {
                    method: 'fileInput',
                    files: files,
                    folderName: folderName,
                    success: true
                };
                
                handleFolderSelectionResult(result);
                
            } catch (error) {
                console.error('File input error:', error);
                showStatus('error', `Failed to process files: ${error.message}`);
            }
        });

        // Handle drag and drop
        const folderSelection = document.getElementById('folderSelection');
        
        folderSelection.addEventListener('dragover', function(e) {
            e.preventDefault();
            folderSelection.classList.add('dragover');
        });

        folderSelection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            folderSelection.classList.remove('dragover');
        });

        folderSelection.addEventListener('drop', function(e) {
            e.preventDefault();
            folderSelection.classList.remove('dragover');
            
            try {
                showStatus('info', 'Processing dropped files...');
                
                // Use the file system access module for drag & drop
                const result = window.fileSystemModule.accessViaDragDrop(e.dataTransfer);
                
                if (result.success) {
                    handleFolderSelectionResult(result);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Drag & drop error:', error);
                showStatus('error', `Failed to process dropped files: ${error.message}`);
            }
        });

        // Display file list
        function displayFileList(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = `${index + 1}. ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileList.appendChild(fileItem);
            });
            
            fileList.style.display = 'block';
        }

        // Display sorting information to user - Step 1.4
        function displaySortingInfo(sortingAnalysis) {
            const sortingInfo = document.getElementById('sortingInfo');
            if (sortingInfo) {
                sortingInfo.innerHTML = `
                    <div class="sorting-info">
                        <strong>Sorting:</strong> ${sortingAnalysis.recommended} 
                        (${Math.round(sortingAnalysis.confidence * 100)}% confidence)
                        <br><small>${sortingAnalysis.reason}</small>
                        <br>
                        <button onclick="changeSortingMethod('natural')" class="sort-btn" 
                                ${sortingAnalysis.recommended === 'natural' ? 'disabled' : ''}>
                            Natural/Numerical
                        </button>
                        <button onclick="changeSortingMethod('dateModified')" class="sort-btn"
                                ${sortingAnalysis.recommended === 'dateModified' ? 'disabled' : ''}>
                            By Date Modified
                        </button>
                    </div>
                `;
                sortingInfo.style.display = 'block';
            }
        }

        // Change sorting method - Step 1.4
        function changeSortingMethod(newMethod) {
            if (selectedFiles.length === 0) {
                showStatus('error', 'No files selected to sort');
                return;
            }

            console.log(`Changing sorting method to: ${newMethod}`);
            selectedFiles = window.fileSystemModule.sortFiles(selectedFiles, newMethod);
            
            showStatus('success', `Files re-sorted using ${newMethod} method`);
            displayFileList(selectedFiles);
            
            // Update sorting info display
            const sortingAnalysis = {
                recommended: newMethod,
                confidence: 1.0,
                reason: `Manually selected ${newMethod} sorting`
            };
            displaySortingInfo(sortingAnalysis);
        }

        // Show status message
        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
        }

        // Phase 2: Video Creation Implementation (Updated for Step 2.2)
        async function processImages() {
            if (!selectedFiles || selectedFiles.length === 0) {
                showStatus('error', 'No images selected. Please select a folder first.');
                return;
            }

            try {
                showStatus('info', 'Starting advanced video creation process...');
                
                // Create image-to-video converter instance
                const converter = new ImageToVideoConverter();
                
                // Set up progress tracking with enhanced UI (Step 2.3)
                converter.setCallbacks(
                    (progress) => {
                        // Handle both basic and enhanced progress updates
                        if (progress.enhanced) {
                            updateEnhancedProgress(progress);
                        } else {
                            showStatus('info', `${progress.message}${progress.percentage ? ` (${progress.percentage}%)` : ''}`);
                            if (progress.percentage !== null) {
                                updateProgressBar(progress.percentage);
                            }
                        }
                        
                        // Update enhanced progress for all progress types
                        updateEnhancedProgress(progress);
                    },
                    (error) => {
                        console.error('Conversion error:', error);
                        showStatus('error', `Conversion failed: ${error.error}`);
                        hideProgressBar();
                    },
                    (result) => {
                        console.log('Conversion completed:', result);
                        hideProgressBar();
                        displayAdvancedVideoSummary(result);
                    }
                );
                
                // Configure video settings (get from UI settings in Phase 4)
                const videoSettings = {
                    frameRate: 15,
                    quality: 'medium',
                    resolution: 'original',
                    codec: 'libx264',
                    format: 'mp4'
                };
                
                converter.updateSettings(videoSettings);
                
                showStatus('info', `Processing ${selectedFiles.length} images for video creation...`);
                
                // Set up enhanced progress tracking (Step 2.3)
                setupEnhancedProgressTracking();
                
                // Convert images to video
                const result = await converter.convertImagesToVideo(selectedFiles);
                
                if (result.success) {
                    showStatus('success', `Video created successfully! ${result.filename}`);
                    
                    // Store video data for additional operations (Step 3.1)
                    currentVideoBlob = result.videoBlob;
                    currentVideoFilename = result.filename;
                    
                    // Download the video with enhanced save functionality
                    await downloadVideo(result.videoBlob, result.filename);
                    
                    // Display comprehensive results
                    displayAdvancedVideoSummary(result);
                    
                } else {
                    throw new Error('Video creation failed');
                }
                
            } catch (error) {
                console.error('Video processing error:', error);
                showStatus('error', `Video creation failed: ${error.message}`);
                hideProgressBar();
            }
        }
        
        // Update progress bar display
        function updateProgressBar(percentage) {
            let progressContainer = document.getElementById('progressContainer');
            let progressFill = document.getElementById('progressFill');
            
            if (!progressContainer) {
                // Create progress bar if it doesn't exist
                progressContainer = document.createElement('div');
                progressContainer.id = 'progressContainer';
                progressContainer.className = 'progress-container';
                progressContainer.innerHTML = `
                    <h4>Video Creation Progress:</h4>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%;">0%</div>
                    </div>
                `;
                document.getElementById('status').parentNode.insertBefore(progressContainer, document.getElementById('status').nextSibling);
                progressFill = document.getElementById('progressFill');
            }
            
            progressContainer.style.display = 'block';
            progressFill.style.width = `${percentage}%`;
            progressFill.textContent = `${percentage}%`;
        }
        
        // Hide progress bar
        function hideProgressBar() {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            const enhancedProgressContainer = document.getElementById('enhancedProgressContainer');
            if (enhancedProgressContainer) {
                enhancedProgressContainer.style.display = 'none';
            }
        }
        
        // Enhanced Progress Tracking Functions (Step 2.3)
        function setupEnhancedProgressTracking() {
            // Create enhanced progress container if it doesn't exist
            let enhancedContainer = document.getElementById('enhancedProgressContainer');
            if (!enhancedContainer) {
                enhancedContainer = document.createElement('div');
                enhancedContainer.id = 'enhancedProgressContainer';
                enhancedContainer.className = 'enhanced-progress-container';
                enhancedContainer.innerHTML = createEnhancedProgressHTML();
                
                const statusElement = document.getElementById('status');
                statusElement.parentNode.insertBefore(enhancedContainer, statusElement.nextSibling);
            }
            
            enhancedContainer.style.display = 'block';
        }
        
        function createEnhancedProgressHTML() {
            return `
                <div class="progress-header">
                    <div class="progress-title">Video Creation Progress</div>
                    <div id="etaDisplay" class="eta-display">Calculating ETA...</div>
                </div>
                
                <div class="step-progress">
                    <div id="stepIndicators"></div>
                    <div id="currentItem" class="current-item"></div>
                    
                    <div class="progress-bar">
                        <div id="enhancedProgressFill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div id="statisticsGrid" class="statistics-grid">
                    <div class="stat-item">
                        <div id="elapsedTime" class="stat-value">0s</div>
                        <div class="stat-label">Elapsed</div>
                    </div>
                    <div class="stat-item">
                        <div id="itemsPerSecond" class="stat-value">0</div>
                        <div class="stat-label">Items/sec</div>
                    </div>
                    <div class="stat-item">
                        <div id="completedSteps" class="stat-value">0/0</div>
                        <div class="stat-label">Steps</div>
                    </div>
                    <div class="stat-item">
                        <div id="confidence" class="stat-value">
                            <span class="confidence-indicator confidence-low">Low</span>
                        </div>
                        <div class="stat-label">ETA Confidence</div>
                    </div>
                </div>
            `;
        }
        
        function updateEnhancedProgress(progressData) {
            if (progressData.step === 'step-progress') {
                updateStepIndicators(progressData.stepInfo);
            } else if (progressData.step === 'eta-update') {
                updateETADisplay(progressData.eta);
            } else if (progressData.step === 'statistics-update') {
                updateStatisticsDisplay(progressData.statistics);
            } else if (progressData.overall !== undefined) {
                updateOverallProgress(progressData);
            }
        }
        
        function updateStepIndicators(stepInfo) {
            const stepIndicators = document.getElementById('stepIndicators');
            if (!stepIndicators) return;
            
            const steps = [
                { id: 'validation', name: 'Image Validation' },
                { id: 'processing', name: 'Image Processing' },
                { id: 'encoder-init', name: 'Encoder Setup' },
                { id: 'encoding', name: 'Video Encoding' },
                { id: 'finalization', name: 'Finalization' }
            ];
            
            let html = '';
            steps.forEach((step, index) => {
                let status = 'pending';
                if (index < stepInfo.completedSteps) {
                    status = 'completed';
                } else if (stepInfo.currentStep === step.id) {
                    status = 'active';
                }
                
                html += `
                    <div class="step-indicator">
                        <div class="step-number ${status}">${index + 1}</div>
                        <div class="step-name">${step.name}</div>
                        <div class="step-status">${status}</div>
                    </div>
                `;
            });
            
            stepIndicators.innerHTML = html;
            
            // Update completed steps counter
            const completedStepsElement = document.getElementById('completedSteps');
            if (completedStepsElement) {
                completedStepsElement.textContent = `${stepInfo.completedSteps}/${stepInfo.totalSteps}`;
            }
        }
        
        function updateETADisplay(eta) {
            const etaDisplay = document.getElementById('etaDisplay');
            if (etaDisplay) {
                etaDisplay.textContent = `ETA: ${eta.formatted}`;
            }
            
            const confidenceElement = document.getElementById('confidence');
            if (confidenceElement) {
                confidenceElement.innerHTML = `
                    <span class="confidence-indicator confidence-${eta.confidence}">${eta.confidence}</span>
                `;
            }
        }
        
        function updateStatisticsDisplay(statistics) {
            // Update elapsed time
            const elapsedTimeElement = document.getElementById('elapsedTime');
            if (elapsedTimeElement) {
                elapsedTimeElement.textContent = statistics.timing.totalElapsedFormatted;
            }
            
            // Update items per second
            const itemsPerSecondElement = document.getElementById('itemsPerSecond');
            if (itemsPerSecondElement) {
                const rate = statistics.performance.overallItemsPerSecond.toFixed(1);
                itemsPerSecondElement.textContent = rate;
            }
        }
        
        function updateOverallProgress(progressData) {
            const progressFill = document.getElementById('enhancedProgressFill');
            if (progressFill) {
                const percentage = Math.round(progressData.overall || 0);
                progressFill.style.width = `${percentage}%`;
                progressFill.textContent = `${percentage}%`;
            }
            
            const currentItemElement = document.getElementById('currentItem');
            if (currentItemElement && progressData.currentItem) {
                currentItemElement.textContent = `Processing: ${progressData.currentItem}`;
            }
        }
        
        // Enhanced video saving functionality (Step 3.1)
        let fileSaver = null;
        
        // Initialize file saver
        function initializeFileSaver() {
            if (!fileSaver) {
                fileSaver = new FileSaver();
                console.log('FileSaver initialized:', fileSaver.getBrowserCapabilities());
            }
            return fileSaver;
        }
        
        // Enhanced video download/save function (Step 3.1)
        async function downloadVideo(blob, filename) {
            const saver = initializeFileSaver();
            
            try {
                // Show save status
                showStatus('info', 'Saving video file...');
                
                // Save the video with enhanced options
                const result = await saver.saveVideo(blob, filename, {
                    generateUniqueNames: true,
                    confirmOverwrite: true
                });
                
                if (result.success) {
                    showStatus('success', 
                        `Video saved successfully! ` +
                        `File: ${result.filename} (${(result.size / 1024 / 1024).toFixed(2)} MB) ` +
                        `via ${result.method}${result.location ? ` to ${result.location}` : ''}`
                    );
                    
                    // Display save result details
                    displaySaveResult(result);
                    
                    return result;
                } else {
                    if (result.cancelled) {
                        showStatus('info', 'Save operation was cancelled by user');
                    } else {
                        throw new Error(result.error || 'Save operation failed');
                    }
                }
            } catch (error) {
                console.error('Failed to save video:', error);
                showStatus('error', `Failed to save video: ${error.message}`);
                
                // Fall back to basic download if enhanced save fails
                try {
                    console.log('Falling back to basic download method...');
                    return await basicVideoDownload(blob, filename);
                } catch (fallbackError) {
                    console.error('Fallback download also failed:', fallbackError);
                    showStatus('error', `All save methods failed: ${fallbackError.message}`);
                    return { success: false, error: fallbackError.message };
                }
            }
        }
        
        // Basic video download (fallback method)
        async function basicVideoDownload(blob, filename) {
            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Clean up URL object
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                showStatus('success', `Video downloaded using fallback method: ${filename}`);
                
                return {
                    success: true,
                    method: 'fallback-download',
                    filename: filename,
                    location: 'Browser downloads folder',
                    size: blob.size
                };
            } catch (error) {
                throw new Error(`Fallback download failed: ${error.message}`);
            }
        }
        
        // Display detailed save result (Step 3.1)
        function displaySaveResult(saveResult) {
            const existingSaveResult = document.querySelector('.save-result-details');
            if (existingSaveResult) {
                existingSaveResult.remove();
            }
            
            const saveResultElement = document.createElement('div');
            saveResultElement.className = 'save-result-details';
            saveResultElement.innerHTML = `
                <div style="margin-top: 15px; padding: 15px; background-color: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4>üíæ File Save Details</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <div>
                            <strong>üìÅ File Information:</strong><br>
                            <small>Name: ${saveResult.filename}</small><br>
                            <small>Size: ${(saveResult.size / 1024 / 1024).toFixed(2)} MB</small><br>
                            <small>Saved: ${new Date(saveResult.timestamp).toLocaleString()}</small>
                        </div>
                        
                        <div>
                            <strong>üîß Save Method:</strong><br>
                            <small>Method: ${saveResult.method}</small><br>
                            <small>Location: ${saveResult.location || 'Default location'}</small><br>
                            ${saveResult.note ? `<small>Note: ${saveResult.note}</small>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn" onclick="showSaveOptions()">‚öôÔ∏è Save Options</button>
                        <button class="btn" onclick="saveWithDifferentMethod('${saveResult.filename}')">üíæ Save Copy</button>
                        <button class="btn test-video-btn" onclick="testVideoFile()">‚ñ∂Ô∏è Test Saved Video</button>
                    </div>
                </div>
            `;
            
            const statusElement = document.getElementById('statusMessage');
            statusElement.parentNode.insertBefore(saveResultElement, statusElement.nextSibling);
        }
        
        // Show save options dialog (Step 3.1)
        function showSaveOptions() {
            const saver = initializeFileSaver();
            const capabilities = saver.validateSaveCapabilities();
            const currentSettings = saver.settings;
            
            const optionsDialog = document.createElement('div');
            optionsDialog.id = 'saveOptionsDialog';
            optionsDialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const dialogContent = document.createElement('div');
            dialogContent.style.cssText = `
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            dialogContent.innerHTML = `
                <h3>Save Options & Capabilities</h3>
                
                <div style="margin: 20px 0;">
                    <h4>Available Save Methods:</h4>
                    ${capabilities.available.map(method => `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid ${method.recommended ? '#28a745' : '#6c757d'}; border-radius: 4px;">
                            <strong>${method.method}</strong> ${method.recommended ? '‚úÖ' : 'üìÅ'}
                            <br><small>${method.description}</small>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Current Settings:</h4>
                    <label style="display: block; margin: 10px 0;">
                        <input type="checkbox" id="generateUniqueNames" ${currentSettings.generateUniqueNames ? 'checked' : ''}> 
                        Generate unique filenames with timestamps
                    </label>
                    <label style="display: block; margin: 10px 0;">
                        <input type="checkbox" id="confirmOverwrite" ${currentSettings.confirmOverwrite ? 'checked' : ''}> 
                        Confirm before overwriting existing files
                    </label>
                    <label style="display: block; margin: 10px 0;">
                        <input type="checkbox" id="autoSave" ${currentSettings.autoSave ? 'checked' : ''}> 
                        Auto-save without prompting (when possible)
                    </label>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="applySaveOptions()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px;">Apply Settings</button>
                    <button onclick="closeSaveOptions()" style="padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px;">Close</button>
                </div>
            `;
            
            optionsDialog.appendChild(dialogContent);
            document.body.appendChild(optionsDialog);
            
            // Add global functions for dialog interaction
            window.applySaveOptions = () => {
                const newSettings = {
                    generateUniqueNames: document.getElementById('generateUniqueNames').checked,
                    confirmOverwrite: document.getElementById('confirmOverwrite').checked,
                    autoSave: document.getElementById('autoSave').checked
                };
                
                saver.updateSettings(newSettings);
                showStatus('success', 'Save options updated successfully');
                document.body.removeChild(optionsDialog);
                delete window.applySaveOptions;
                delete window.closeSaveOptions;
            };
            
            window.closeSaveOptions = () => {
                document.body.removeChild(optionsDialog);
                delete window.applySaveOptions;
                delete window.closeSaveOptions;
            };
        }
        
        // Save with different method (Step 3.1)
        async function saveWithDifferentMethod(filename) {
            if (!currentVideoBlob) {
                showStatus('error', 'No video data available. Please create a video first.');
                return;
            }
            
            const saver = initializeFileSaver();
            
            try {
                showStatus('info', 'Saving additional copy with different method...');
                
                // Let user choose save method
                const result = await saver.saveWithMethodChoice(currentVideoBlob, filename || currentVideoFilename);
                
                if (result && result.success) {
                    showStatus('success', `Additional copy saved: ${result.filename} via ${result.method}`);
                    displaySaveResult(result);
                } else if (result && result.cancelled) {
                    showStatus('info', 'Save operation was cancelled by user');
                } else {
                    showStatus('error', 'Failed to save additional copy');
                }
            } catch (error) {
                console.error('Failed to save with different method:', error);
                showStatus('error', `Failed to save copy: ${error.message}`);
            }
        }
        
        // Display advanced video creation summary (Step 2.2 enhancement)
        function displayAdvancedVideoSummary(result) {
            const summaryDiv = document.getElementById('status');
            const existingSummary = document.querySelector('.video-summary-advanced');
            
            // Remove existing summary if present
            if (existingSummary) {
                existingSummary.remove();
            }
            
            const summaryElement = document.createElement('div');
            summaryElement.className = 'video-summary-advanced';
            summaryElement.innerHTML = `
                <div style="margin-top: 20px; padding: 20px; background-color: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4>‚úÖ Video Creation Completed Successfully</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h5>üìÅ File Information</h5>
                            <p><strong>Filename:</strong> ${result.filename}</p>
                            <p><strong>Size:</strong> ${result.metadata.videoSize ? (result.metadata.videoSize / 1024 / 1024).toFixed(2) + ' MB' : 'N/A'}</p>
                            <p><strong>Created:</strong> ${new Date(result.metadata.createdAt).toLocaleString()}</p>
                        </div>
                        
                        <div>
                            <h5>üé¨ Video Properties</h5>
                            <p><strong>Duration:</strong> ${result.metadata.duration.formatted}</p>
                            <p><strong>Dimensions:</strong> ${result.metadata.dimensions.width}x${result.metadata.dimensions.height}</p>
                            <p><strong>Aspect Ratio:</strong> ${result.metadata.dimensions.aspectRatio}</p>
                        </div>
                        
                        <div>
                            <h5>‚öôÔ∏è Encoding Settings</h5>
                            <p><strong>Frame Rate:</strong> ${result.metadata.settings.frameRate} FPS</p>
                            <p><strong>Quality:</strong> ${result.metadata.settings.quality}</p>
                            <p><strong>Codec:</strong> ${result.metadata.settings.codec}</p>
                        </div>
                        
                        <div>
                            <h5>üìä Processing Statistics</h5>
                            <p><strong>Input Images:</strong> ${result.metadata.inputImageCount}</p>
                            <p><strong>Processed:</strong> ${result.metadata.processedImageCount}</p>
                            <p><strong>Compression:</strong> ${result.statistics.compressionRatio.percentage}% reduction</p>
                            <p><strong>Processing Time:</strong> ${(result.statistics.totalProcessingTime / 1000).toFixed(1)}s</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn test-video-btn" onclick="testAdvancedVideoPlayback('${result.filename}')">‚ñ∂Ô∏è Test Video Playback</button>
                        <button class="btn" onclick="showVideoMetadata(${JSON.stringify(result.metadata).replace(/"/g, '&quot;')})">üìã View Full Metadata</button>
                    </div>
                </div>
            `;
            
            summaryDiv.parentNode.insertBefore(summaryElement, summaryDiv.nextSibling);
            hideProgressBar();
        }
        
        // Test video file functionality (Step 3.2 implementation)
        async function testVideoFile() {
            if (!currentVideoBlob) {
                showStatus('error', 'No video data available. Please create a video first.');
                return;
            }
            
            try {
                showStatus('info', 'Starting comprehensive video validation...');
                
                // Initialize video tester
                const tester = new VideoTester();
                const reporter = new VideoReporter();
                
                // Set up progress callbacks
                tester.setCallbacks(
                    (start) => {
                        showStatus('info', `Video testing started: ${start.message}`);
                        showVideoTestProgress('Testing video quality and playback...', 0);
                    },
                    (progress) => {
                        showVideoTestProgress(progress.message, progress.percentage);
                    },
                    async (results) => {
                        hideVideoTestProgress();
                        
                        // Generate comprehensive report
                        const report = reporter.generateTestReport(results, currentVideoBlob);
                        
                        if (results.success) {
                            showStatus('success', `Video validation completed successfully! All tests passed.`);
                            displayVideoTestResults(results, report);
                        } else {
                            showStatus('warning', `Video validation completed with issues. Check test results for details.`);
                            displayVideoTestResults(results, report);
                        }
                    },
                    (error) => {
                        hideVideoTestProgress();
                        showStatus('error', `Video testing failed: ${error.error}`);
                        console.error('Video testing error:', error);
                    }
                );
                
                // Run comprehensive test
                await tester.testVideo(currentVideoBlob, currentVideoFilename);
                
            } catch (error) {
                console.error('Video testing error:', error);
                showStatus('error', `Video testing failed: ${error.message}`);
                hideVideoTestProgress();
            }
        }
        
        // Show video test progress
        function showVideoTestProgress(message, percentage) {
            let progressContainer = document.getElementById('videoTestProgress');
            
            if (!progressContainer) {
                progressContainer = document.createElement('div');
                progressContainer.id = 'videoTestProgress';
                progressContainer.className = 'video-progress';
                progressContainer.innerHTML = `
                    <h4>üî¨ Video Testing Progress</h4>
                    <div id="videoTestMessage" class="progress-message"></div>
                    <div class="progress-bar">
                        <div id="videoTestProgressFill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                `;
                
                const statusElement = document.getElementById('statusMessage');
                statusElement.parentNode.insertBefore(progressContainer, statusElement.nextSibling);
            }
            
            progressContainer.style.display = 'block';
            document.getElementById('videoTestMessage').textContent = message;
            
            if (percentage !== undefined) {
                const progressFill = document.getElementById('videoTestProgressFill');
                progressFill.style.width = `${percentage}%`;
                progressFill.textContent = `${percentage}%`;
            }
        }
        
        // Hide video test progress
        function hideVideoTestProgress() {
            const progressContainer = document.getElementById('videoTestProgress');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }
        
        // Display video test results
        function displayVideoTestResults(testResults, report) {
            const existingResults = document.querySelector('.video-test-results');
            if (existingResults) {
                existingResults.remove();
            }
            
            const resultsElement = document.createElement('div');
            resultsElement.className = 'video-test-results';
            
            const summary = report.summary;
            const statusColor = summary.overall === 'PASSED' ? '#28a745' : '#dc3545';
            const statusIcon = summary.overall === 'PASSED' ? '‚úÖ' : '‚ùå';
            
            resultsElement.innerHTML = `
                <div style="margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid ${statusColor};">
                    <h4>${statusIcon} Video Validation Results</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h5>üìã Test Summary</h5>
                            <p><strong>Overall Status:</strong> <span style="color: ${statusColor};">${summary.overall}</span></p>
                            <p><strong>Tests Passed:</strong> ${summary.testsPassed}/${summary.testsRun}</p>
                            <p><strong>Duration:</strong> ${summary.testDuration}</p>
                            <p><strong>Warnings:</strong> ${summary.warnings}</p>
                        </div>
                        
                        <div>
                            <h5>üé¨ Video Quality</h5>
                            <p><strong>Duration:</strong> ${summary.videoInfo?.duration || 'Unknown'}</p>
                            <p><strong>Dimensions:</strong> ${summary.videoInfo?.dimensions || 'Unknown'}</p>
                            <p><strong>File Size:</strong> ${summary.videoInfo?.fileSize || 'Unknown'}</p>
                            <p><strong>Aspect Ratio:</strong> ${summary.videoInfo?.aspectRatio || 'Unknown'}</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h5>üî¨ Test Details</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${Object.entries(testResults.tests).map(([testName, result]) => {
                                const icon = result.status === 'passed' ? '‚úÖ' : result.status === 'failed' ? '‚ùå' : '‚ö†Ô∏è';
                                return `
                                    <div style="padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; background-color: white;">
                                        <strong>${icon} ${formatTestName(testName)}</strong>
                                        <br><small style="color: #6c757d;">${result.status.toUpperCase()}</small>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    ${testResults.warnings && testResults.warnings.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <h5>‚ö†Ô∏è Warnings</h5>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${testResults.warnings.map(warning => `<li style="color: #856404;">${warning}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${testResults.recommendations && testResults.recommendations.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <h5>üí° Recommendations</h5>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${testResults.recommendations.map(rec => `<li style="color: #004085;">${rec}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="runQuickVideoTest()">üîÑ Quick Re-test</button>
                        <button class="btn" onclick="showDetailedTestReport(${JSON.stringify(report).replace(/"/g, '&quot;')})">üìÑ Detailed Report</button>
                        <button class="btn" onclick="downloadTestReport(${JSON.stringify(report).replace(/"/g, '&quot;')})">üíæ Save Report</button>
                        <button class="btn test-video-btn" onclick="playTestVideo()">‚ñ∂Ô∏è Play Video</button>
                    </div>
                </div>
            `;
            
            const statusElement = document.getElementById('statusMessage');
            statusElement.parentNode.insertBefore(resultsElement, statusElement.nextSibling);
        }
        
        // Format test name for display
        function formatTestName(testName) {
            return testName
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }
        
        // Run quick video test
        async function runQuickVideoTest() {
            if (!currentVideoBlob) {
                showStatus('error', 'No video data available.');
                return;
            }
            
            try {
                showStatus('info', 'Running quick video validation...');
                const tester = new VideoTester();
                const reporter = new VideoReporter();
                
                showVideoTestProgress('Quick validation in progress...', 50);
                
                const results = await tester.quickTest(currentVideoBlob, currentVideoFilename);
                const report = reporter.generateTestReport(results, currentVideoBlob);
                
                hideVideoTestProgress();
                
                if (results.success) {
                    showStatus('success', 'Quick validation passed!');
                } else {
                    showStatus('warning', 'Quick validation found issues.');
                }
                
                displayVideoTestResults(results, report);
                
            } catch (error) {
                hideVideoTestProgress();
                showStatus('error', `Quick test failed: ${error.message}`);
            }
        }
        
        // Show detailed test report
        function showDetailedTestReport(report) {
            const reportWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            const reporter = new VideoReporter();
            const htmlReport = reporter.exportAsHTML(report);
            
            reportWindow.document.write(htmlReport);
            reportWindow.document.close();
        }
        
        // Download test report
        async function downloadTestReport(report) {
            try {
                const reporter = new VideoReporter();
                const result = await reporter.saveReport(report, currentVideoFilename || 'video', 'html');
                
                if (result.success) {
                    showStatus('success', `Test report saved: ${result.filename}`);
                } else {
                    showStatus('error', `Failed to save report: ${result.error}`);
                }
            } catch (error) {
                showStatus('error', `Failed to save report: ${error.message}`);
            }
        }
        
        // Play test video in popup
        function playTestVideo() {
            if (!currentVideoBlob) {
                showStatus('error', 'No video data available.');
                return;
            }
            
            try {
                const videoUrl = URL.createObjectURL(currentVideoBlob);
                const playerWindow = window.open('', '_blank', 'width=800,height=600');
                
                playerWindow.document.write(`
                    <html>
                    <head>
                        <title>Video Playback Test - ${currentVideoFilename}</title>
                        <style>
                            body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background-color: #f5f5f5; }
                            .container { max-width: 800px; margin: 0 auto; text-align: center; }
                            video { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; }
                            .info { margin: 20px 0; padding: 15px; background-color: white; border-radius: 8px; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h2>Video Playback Test</h2>
                            <div class="info">
                                <p><strong>File:</strong> ${currentVideoFilename}</p>
                                <p><strong>Size:</strong> ${(currentVideoBlob.size / 1024 / 1024).toFixed(2)} MB</p>
                                <p>Use the video controls to test playback functionality.</p>
                            </div>
                            <video controls autoplay>
                                <source src="${videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="info">
                                <p><small>This window can be closed when testing is complete.</small></p>
                                <button onclick="window.close()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                
                playerWindow.document.close();
                
                // Clean up URL after window is closed
                playerWindow.addEventListener('beforeunload', () => {
                    URL.revokeObjectURL(videoUrl);
                });
                
                showStatus('info', 'Video playback test opened in new window.');
                
            } catch (error) {
                showStatus('error', `Failed to open video player: ${error.message}`);
            }
        }
        
        // Store current video blob for additional operations (Step 3.1 enhancement)
        let currentVideoBlob = null;
        let currentVideoFilename = null;
        
        // Enhanced video creation completion handler
        function handleVideoCreationSuccess(result) {
            // Store video data for additional operations
            currentVideoBlob = result.videoBlob;
            currentVideoFilename = result.filename;
            
            console.log('Video creation completed:', result);
            hideProgressBar();
            displayAdvancedVideoSummary(result);
        }
        
        // Show detailed metadata
        function showVideoMetadata(metadata) {
            const metadataWindow = window.open('', '_blank', 'width=600,height=400');
            metadataWindow.document.write(`
                <html>
                <head><title>Video Metadata - ${metadata.createdAt}</title></head>
                <body style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2>Video Creation Metadata</h2>
                    <pre style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; overflow: auto;">
${JSON.stringify(metadata, null, 2)}
                    </pre>
                </body>
                </html>
            `);
        }

        function showSettings() {
            showStatus('info', 'Settings panel will be implemented in Phase 4.');
        }

        // Test functions for validation - Updated for Step 1.2 and 1.4
        window.testInterface = {
            getSelectedFiles: () => selectedFiles,
            getFolderName: () => folderName,
            selectTestFolder: (testFiles) => {
                // Create a mock result object for testing
                const mockResult = {
                    method: 'test',
                    files: testFiles.filter(file => window.fileSystemModule.isJPEGFile(file)),
                    folderName: 'test_folder',
                    success: true
                };
                handleFolderSelectionResult(mockResult);
            },
            isProcessButtonEnabled: () => !document.getElementById('processBtn').disabled,
            getFileSystemModule: () => window.fileSystemModule,
            getBrowserCapabilities: () => window.fileSystemModule.getBrowserInfo(),
            validateJPEGFile: (file) => window.fileSystemModule.isValidJPEGFile(file),
            validateJPEGSignature: (file) => window.fileSystemModule.validateJPEGSignature(file),
            validateFilesBatch: (files, options) => window.fileSystemModule.validateFilesBatch(files, options),
            // Step 1.4: Sorting functionality
            sortFiles: (files, method) => window.fileSystemModule.sortFiles(files, method),
            sortFilesNatural: (files) => window.fileSystemModule.sortFilesNatural(files),
            sortFilesByDate: (files) => window.fileSystemModule.sortFilesByDate(files),
            analyzeSortingPattern: (files) => window.fileSystemModule.analyzeSortingPattern(files),
            changeSortingMethod: (method) => changeSortingMethod(method),
            displaySortingInfo: (analysis) => displaySortingInfo(analysis)
        };
    </script>
    
    <!-- Phase 2: Video Generation Engine -->
    <script src="progressTracker.js"></script>
    <script src="errorHandler.js"></script>
    <script src="videoEncoder.js"></script>
    <script src="imageToVideoConverter.js"></script>
    
    <!-- Phase 3: Output and Validation -->
    <script src="fileSaver.js"></script>
    <script src="videoTester.js"></script>
    <script src="videoReporter.js"></script>
</body>
</html>
